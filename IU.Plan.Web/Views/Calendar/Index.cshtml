@model CalendarViewModel
@using IU.Plan.Web.Models
@using IU.Plan.Web.Extensions;

@{
    ViewBag.Title = "Calendar";

    var dayCounter = 1;
}

@helper PrintEvents(int dayCounter)
{
    var currDay = new DateTime(Model.BeginOfPeriod.Year, Model.BeginOfPeriod.Month, dayCounter);
    var events = Model.Events.Where(evnt => evnt.StartDateTime.Value.Day == currDay.Day);
    <ul class="list-group">
        @foreach (var evt in events)
        {
            if (evt != null)
            {
                <li class="list-group-item list-group-item-info">
                    <div>
                        @evt.Title
                        <button onclick="getViewModal('@evt.Guid')">Смотреть</button>
                        <button onclick="getEditModal('@evt.Guid')">Редактировать</button>
                    </div>
                </li>
            }
        }
    </ul>
}

<script type="text/javascript">
    function getViewModal(uid) {
        console.log(uid);
        $.ajax({
            url: '/Event/MiniDetails?uid=' + uid,
            success: function (data) {
                $('#MiniDetailsResult').html(data);

                $("#MiniDetailsResult").dialog({
                    width: 'auto',
                    modal: true,
                    buttons: {
                        Ok: function () {
                            $(this).dialog("close");
                        }
                    }
                });
                console.log(data);
            }
        });
    }
    function getEditModal(uid) {
        console.log(uid);
        $.ajax({
            url: '/Event/Edit?uid=' + uid,
            success: function (data) {
                $('#EditResult').html(data);

                $("#EditResult").dialog({
                    width: 'auto',
                    modal: true,
                    buttons: {
                        Ok: function () {
                            $(this).dialog("close");
                        }
                    }
                });
                console.log(data);
            }
        });
    }
</script>


<div>
    @{
        var prevPeriod = Model.BeginOfPeriod.AddMonths(-1);
        var nextPeriod = Model.BeginOfPeriod.AddMonths(1);
        var today = DateTime.Today;
    }

    <h2>Календарь для @Model.BeginOfPeriod.Month, @Model.BeginOfPeriod.Year</h2>
    
    <nav aria-label="...">
        <ul class="pager">
            <li class="previous"><a href="@Url.Action("Index", new { year = prevPeriod.Year, month = prevPeriod.Month })"><span aria-hidden="true">&larr;</span> Туда</a></li>
            <li class="today"><a href="@Url.Action("Index", new { year = today.Year, month = today.Month })">Сегодня</a></li>
            <li class="next"><a href="@Url.Action("Index", new { year = nextPeriod.Year, month = nextPeriod.Month })">Сюда <span aria-hidden="true">&rarr;</span></a></li>
        </ul>
    </nav>
</div>

<div class="table-responsive">

    <table class="table table-bordered">
        <tr>
            <th>понедельник</th>
            <th>вторник</th>
            <th>среда</th>
            <th>четверг</th>
            <th>пятница</th>
            <th>суббота</th>
            <th>воскресенье</th>
        </tr>
        @for (int i = 0; i < Model.RowCount; i++)
        {
            <tr>
                @for (int j = 0; j < Model.ColCount; j++)
                {
                    if (dayCounter <= Model.EndOfPeriod.Day)
                    {
                        var currDay = new DateTime(Model.BeginOfPeriod.Year, Model.BeginOfPeriod.Month, dayCounter);

                        if (currDay.DayOfWeek.ToInt() == j)
                        {
                            var tdClass = currDay == DateTime.Now.Date ? "bg-info" : "";
                            <td class=@(tdClass)>
                                @((dayCounter <= Model.EndOfPeriod.Day) ? $"{dayCounter}" : "")
                                @PrintEvents(dayCounter++)
                            </td>
                            continue;
                        }
                    }

                    <td></td>
                }
            </tr>
        }
    </table>

</div>

<div id="MiniDetailsResult"></div>
<div id="EditResult"></div>